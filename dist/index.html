<!doctype html>
<html class="no-js" prefix="og: http://ogp.me/ns#" lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="Swing Patrol Classes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <title>Swing Patrol Classes</title>
    <script src="scripts/vue.min.js"></script>
    <script src="scripts/axios.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" rel="stylesheet">

    <link rel="dns-prefetch" href="https://www.swingpatrol.co.uk/">

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">

    <meta property="og:title" content="Swing Patrol Class Info">
    <meta property="og:description" content="Quick and easy way to access the Swing Patrol class plans">
    <meta property="og:image" content="img/social.png">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://swing.me.uk">
    <meta name="twitter:card" content="summary_large_image">

    <style>
        body {
            margin: 0 0 30px 0;
            font-family: 'Open Sans Condensed', sans-serif;
            font-size: 22px;
        }
        @media(max-width: 600px) {
            body {
                font-size: 20px;
            }
        }
        .wrap {
            max-width: 740px;
            margin: 0 auto;
        }

        h1 {
            margin: 6px 0;
            text-align: center;
            color: #333;
            font-size: 24px;
        }

        .center { text-align: center }

        .classes-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .classes-column {
            flex: 1 0 320px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .classes-day {
            text-align: center;
        }

        .classes-day ul {
            max-width: 170px;
            padding: 0;
            list-style: none;
        }

        .classes-day li {
            margin: 4px 0;
            padding: 3px 8px;
            background-color: #f7f6f4;
        }

        .classes-day a {
            display: block;
            font-weight: 700;
            text-decoration: none;
            color: #555;
        }

        .classes-day h2 {
            margin: 10px 0;
            font-size: 32px;
            text-transform: uppercase;
        }

        .class-info header {
            text-align: center;
        }

        .class-info header h2 {
            margin-bottom: 0;
            text-transform: uppercase;
        }

        .title-icons {
            margin-top: 10px;
        }

        .title-icons img {
            width: 36px;
            height: 36px;
        }

        .title-icons a + a {
            margin-left: 12px;
        }

        .class-info .class-more-info {
            margin-top: 10px;
            padding: 5px 1em;
            color: #333333;
        }

        .class-plan-grid {
            display: grid;
            font-weight: 700;
            font-size: 20px;
        }

        @media(max-width: 600px) {
            .class-plan-grid {
                font-size: 14px;
            }
        }

        .class-plan-grid h3 span {
            color: #bbb3a4;
        }

        .cols-2 { grid-template-columns: repeat(2, auto); }
        .cols-3 { grid-template-columns: repeat(3, auto); }
        .cols-4 { grid-template-columns: repeat(4, auto); }
        .cols-5 { grid-template-columns: repeat(5, auto); }

        .class-plan-grid > * {
            padding: 5px 10px;
        }

        .class-plan-grid .cell-is-odd {
            background-color: #f1f1f1;
        }
    </style>
</head>

<body>
<div id="classes-app">

    <main class="wrap">
        <h1>Swing Patrol Classes</h1>

        <section class="classes-container">
            <div class="classes-column">
                <div class="classes-day-wrap">
                    <class-day :day="'Monday'" :classes="classes" :color="'#ffb400'"></class-day>
                </div>
                <div class="classes-day-wrap">
                    <class-day :day="'Tuesday'" :classes="classes" :color="'#01dfa8'"></class-day>
                </div>
            </div>


            <div class="classes-column">
                <div class="classes-day-wrap">
                    <class-day :day="'Wednesday'" :classes="classes" :color="'#ff0066'"></class-day>
                </div>

                <div class="classes-day-wrap">
                    <class-day :day="'Thursday'" :classes="classes" :color="'#b700f3'"></class-day>
                    <class-day :day="'Sunday'" :classes="classes" :color="'#008af5'"></class-day>
                </div>
            </div>

        </section>
    </main>

    <aside class="wrap">
        <class-info id="class-info" class="class-info"></class-info>
    </aside>

</div>

<script>

    Vue.component('class-day', {
        props: ['day','classes', 'color'],
        template:
            `<div class="classes-day">
                <h2 :style="'color: ' + color">{{ day }}</h2>
                <ul>
                    <li v-for="item in classesForDay">
                        <a href="#" @click.prevent="$root.$emit('select-class', {'item':item, 'color':color})" v-html="item.name"></a>
                    </li>
                </ul>
            </div>`,
        computed: {
            classesForDay() {
                return this.classes.filter(item => item.day === this.day);
            },
        }
    });

    Vue.component('class-info', {
        template:
            `<article v-show="name !== undefined">
                <header>
                    <h2 class="center" :style="'color: ' + color" v-html="name"></h2>

                    <div class="class-more-info">
                        <div><strong>{{ day }}</strong></div>
                        <div>{{ teachers }}</div>
                        <div class="title-icons">
                            <a :href="citymapper_url" target="_blank" title="Citymapper"><img src="img/icon-citymapper.png" alt="Citymapper"></a>
                            <a :href="google_maps_url" target="_blank" title="Google Maps"><img src="img/icon-gmaps.png" alt="Google Maps"></a>
                        </div>
                    </div>
                </header>

                <div class="class-plan-grid" :class="'cols-' + (classPlans.length+1)" v-show="planDates.size !== 0">
                    <h3>Date</h3>
                    <h3 v-for="(item, idx) in classPlans">{{ item.level }} <span>({{ findLevel(item, idx) }})</span></h3>

                    <template v-for="(item, idx) in planDates">
                        <div :class="(idx+1) % 2 ? 'cell-is-odd' : ''"> {{ formatDate(item) }} </div>
                        <div :class="(idx+1) % 2 ? 'cell-is-odd' : ''" v-for="planItem in classPlans">
                            {{ planItem.plan.find(entry => entry.date === item).content }}
                        </div>
                    </template>
                </div>

                <p v-show="planDates.size === 0" class="center">Class plan empty</p>
            </article>`,
        data() {
            return {
                name: undefined,
                day: '',
                address: '',
                google_maps_url: '',
                citymapper_url: '',
                teachers: '',
                class_times: [],
                swingpatrol_url: '',
                color: undefined,
                classTimes: [],
                classPlans: [],
                planDates: new Set()
            }
        },
        methods: {
            formatDate(date) {
                let months = {'01':'Jan', '02':'Feb', '03':'Mar', '04':'Apr', '05':'May', '06':'Jun', '07':'Jul', '08':'Aug', '09':'Sep', '10':'Oct', '11':'Nov', '12':'Dec'};
                return date.substring(6) + ' ' + months[date.substring(4,6)];
            },
            findLevel(classItem, idx) {
                let classTime = this.classTimes.find(el => el.level == classItem.level.replace('Level ', ''));
                // Sometimes levels in classPlans don't match the levels in ClassTimes! (e.g. Clapham Junction has levels 1 & 2 in plan but 1 & 1.5 in class times)
                // In this case we use the index and hope they come in the same order (always the case except for Waterloo)
                return classTime ? classTime.time : this.classTimes[idx].time;
            }
        },
        mounted() {
            this.$root.$on('select-class', data => {
                let classData = data.item;
                let plan = [];
                this.planDates.clear();

                if(classData.fields.class_plan !== null) {
                    Object.values(classData.fields.class_plan).forEach(item => plan.push({
                        'level': item.title,
                        'plan': Object.values(item.plan)
                    }));
                    plan.sort((a, b) =>  a.level > b.level ? 1 : -1);

                    for(let level of plan) {
                        Object.values(level.plan).forEach(item => this.planDates.add(item.date));
                    }
                }

                this.classPlans = plan;
                this.name = classData.name;
                this.color = data.color;
                this.day = classData.day;
                this.address = classData.fields.location.address;
                this.classTimes = classData.fields.class_times;
                this.citymapper_url = classData.fields.citymapper_url;
                this.google_maps_url = classData.fields.google_maps_url;
                this.teachers = classData.fields.teachers.map(el => el.name).join(' & ');
            });
        },
        updated: function () {
            document.getElementById("class-info").scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
        }
    });

    new Vue({
        el: '#classes-app',
        data() {
            return {
                classes: []
            }
        },
        mounted() {
            for(let i=1; i<=3; i++) {
                axios.get('https://www.swingpatrol.co.uk/wp-json/classes/all?locations=london&order=date&page=' + i)
                    .then(response => {
                        this.classes.push(...response.data.posts);
                        this.classes.sort((a, b) =>  a.name > b.name ? 1 : -1);
                    })
                    .catch(error => console.log(error));
            }
        },
    });
</script>

</body>
</html>
